before_script:
  - pwd
  - echo 'hola'
after_script:
    - echo 'after'
stages:
    - pre_install
    - build
    - deploy
    - reset
    - clean

pre_install_job:
  stage: pre_install
  script:
    - mkdir /tmp/build
    - sudo cp -rf ./* /tmp/build
    - cd /tmp/build
    - sudo npm run prestart
    - sudo npm install grunt grunt-contrib-coffee grunt-contrib-cssmin grunt-contrib-htmlmin  grunt-contrib-jshint  grunt-contrib-nodeunit grunt-contrib-uglify  grunt-ts
    - sudo npm install -g typings tsc concurrently  lite-server typescript
    - sudo typings install
  when: on_success
  tags:
    - vertederodev

build_job:
  stage: build
  script:
    - cd /tmp/build
    - sudo npm run tsc -w
    - sudo npm run build
  when: on_success
  tags:
    - vertederodev

deploy_job:
  stage: deploy
  script:
    - cd /tmp/build
    - sudo cp -rf build/* ./
    - sudo find ./ -type f -name '*.ts' -delete
    - sudo tar -cvf /var/www/html.tar /var/www/html    
    - sudo rm -rf /var/www/html/*
    - sudo cp -rf ./ /var/www/html/
    - sh /home/ubuntu/Vertedero/conn.sh
  when: on_success 
  tags:
    - vertederodev  

reset_job:
  stage: reset
  script:
    - sudo rm -rf /tmp/build
    - sudo rm -rf /var/www/html/build
    - sudo rm -rf /var/www/html/typings
    - sudo rm -rf /var/www/html/consultas
    - sudo rm /var/www/html/.gitignore
    - sudo rm /var/www/html/.gitlab-ci.yml
    - sudo rm /var/www/html/bs-config.json
    - sudo rm /var/www/html/Gruntfile.js
    - sudo rm /var/www/html/package.json
    - sudo rm /var/www/html/tsconfig.json
    - sudo rm /var/www/html/typings.json
  when: always
  tags:
    - vertederodev
    
clean_job:
  stage: clean
  script:
    - sudo rm -rf /tmp/build
    - sudo rm -rf /var/www/html/*
    - sudo tar -xvf /var/www/html.tar -C /var/www/
  when: on_failure
  tags:
    - vertederodev